# 합의 요청 관리

## 1. 개요
- **화면명**: 합의 요청 관리
- **목적**: 세차 수행 중 발견된 특이사항으로 파트너사가 추가 비용을 요청할 경우, 검토 및 합의(승인/반려/네고) 프로세스를 관리
- **주요 기능**: 요청 목록 조회, 사유 및 현장 사진 확인, 청구 금액 조정, 승인/반려 처리

## 2. 데이터 정책

### 2.1 상태 전이 및 수정 제한
- **수정 권한**: `요청` 상태에서만 청구 금액 수정 및 승인/반려 처리 가능
- **종결 처리**: `승인` 또는 `반려`는 최종 상태, 이후 변경 불가

### 2.2 승인 프로세스 유형

| 구분 | 1단계 승인 | 2단계 승인 |
| :--- | :--- | :--- |
| 노출 방식 | 파트너 + 인터널 동시 노출 | 파트너 선노출 → 선승인 후 인터널 노출 |
| 승인 주체 | 파트너 또는 인터널 (선착순 1인) | 파트너(1차) → 인터널(최종) |
| 목적 | 현장 대기 시간 최소화 | 고비용 건 비용 남용 방지 |

#### 2단계 승인 일시 정책 (인터널 관점)
- **요청 일시**: 1차 처리자(파트너)가 선승인을 완료한 시점
- **처리 일시**: 2차 처리자(인터널)가 최종 승인/반려한 시점

> 1단계 승인의 경우, 요청 일시는 수행원의 합의 요청 접수 시점, 처리 일시는 처리한 시점입니다.

### 2.3 처리 주체 판별
| 처리자 유형 | 표기 | 판별 기준 |
| :--- | :--- | :--- |
| 내부 관리자 | 인터널 (Green 배지) | 영문 닉네임 (예: brown, asti) |
| 파트너 관리자 | 파트너 (Gray 배지) | 한글 이름 (예: 김길동) |

> 2단계 승인에서는 인터널만 처리 가능하므로 항상 "인터널" 표시

### 2.4 합의 요청 발생 케이스 (총 8건)

| # | 요청 유형 | 변경 내용 | 승인 프로세스 |
| :---: | :--- | :--- | :---: |
| 1 | 현장 변경(내부→내외부) | 현장 세차 유형 상향 | 1단계 |
| 2 | 현장 변경(외부→내외부) | 현장 세차 유형 상향 | 1단계 |
| 3 | 현장 변경(라이트→내부) | 현장 세차 유형 상향 | 1단계 |
| 4 | 현장 변경(라이트→외부) | 현장 세차 유형 상향 | 1단계 |
| 5 | 현장 변경(라이트→내외부) | 현장 세차 유형 상향 | 1단계 |
| 6 | 전환(현장→입고) | 파트너 유형 전환 (특수) | 1단계 |
| 7 | 입고 변경(내외부→특수) | 입고 세차 유형 상향 | 2단계 |
| 8 | 입고 변경(내외부→협의) | 입고 세차 유형 상향 | 2단계 |

---

## 3. 화면 구성 및 기능

### 3.1 리스트

- **페이지네이션**: 40건
- **기본 정렬**: 오더 ID 내림차순

#### 검색 및 필터
| 구분 | 필드명 | 타입 | 설명 |
| :--- | :--- | :--- | :--- |
| 필터 | 파트너 이름 | Select | 기본값: 전체 |
| 필터 | 요청 유형 | Select | 기본값: 전체 |
| 기간 | 요청 일 시작~종료 | DatePicker | 기본값: 최근 1개월 |
| 필터 | 합의 유형 | Select | 전체, 1단계 승인, 2단계 승인 |
| 필터 | 상태 | Select | 전체, 요청, 승인, 반려 |

#### 컬럼 정의
| 헤더명 | 설명 |
| :--- | :--- |
| 오더 ID | |
| 차량 번호 | |
| 차종 | |
| 존 이름 | |
| 파트너 이름 | 요청을 보낸 파트너사 |
| 요청 유형 | `{유형}({변경 전}→{변경 후})` 형식 |
| 요청 일시 | `YYYY-MM-DD HH:mm` |
| 합의 유형 | 1단계 / 2단계 |
| 상태 | 요청(Warn), 승인(Ok), 반려(Danger) |
| 처리 주체 | 인터널(Green) / 파트너(Gray), 미처리 시 `-` |
| 처리 일시 | 미처리 시 `-` |

### 3.2 상세 (Drawer)

- **타이틀**: `합의 요청 상세 - {요청ID}`

#### A. 요청 정보 섹션
- 오더 ID, 차량 번호, 차종, 존 이름, 파트너 이름, 요청 유형, 요청 일시
- 합의 유형 (1단계: Ok(Green), 2단계: Warn(Amber) 배지)
- 상태 (요청/승인/반려 배지)
- **1단계**: 처리 주체 (인터널/파트너 배지), 처리자, 처리 일시
- **2단계**: 1차 처리자 (파트너 담당자), 2차 처리자 (인터널 담당자), 처리 일시

#### 금액 및 코멘트
| 필드 | 설명 |
| :--- | :--- |
| 청구 금액 | `요청` 상태에서만 수정 가능, 그 외 비활성화 |
| 요청 코멘트 | 수행원이 입력한 합의 요청 메시지 |
| 반려 코멘트 | `반려` 상태에서만 표시 |

#### B. 현장 사진 섹션
- 세차 전 상태 증빙 사진 미리보기 (현재 Placeholder)

#### C. 승인 및 반려 처리 (Footer)
- `요청` 상태에서만 액션 버튼 노출, 그 외 `닫기`만 제공
- **승인**: 현재 청구 금액을 최종 확정, 상태 → `승인`
- **반려**: 클릭 시 드로어 하단에 반려 사유 입력 영역(Card) 활성화 (팝업 아님)
  - 사유 입력 후 [반려 확정] → 상태 `반려` + 반려 코멘트 저장
  - [취소] → 반려 입력 모드 종료
