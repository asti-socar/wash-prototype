# 합의 요청 관리 기능 명세서

## 1. 개요
- **화면명**: 합의 요청 관리
- **목적**: 세차 수행 중 발견된 특이사항(오염 심각, 추가 과업 등)으로 인해 파트너사가 추가 비용을 요청할 경우, 이를 검토하고 합의(승인/반려/네고)하는 프로세스를 관리합니다.
- **주요 기능**: 요청 목록 조회, 사유 및 현장 사진 확인, 청구 금액 조정, 승인 및 반려 처리.

## 2. 화면 구성 및 기능

### 2.1 합의 요청 목록 (List)
파트너사로부터 접수된 합의 요청 건들을 테이블 형태로 조회합니다.

- **페이지네이션**: 페이지당 **40건** 기준.
- **기본 정렬**: 오더 ID **내림차순** (최신 오더 우선 표시)
- **정렬**: 헤더 클릭 시 오름차순/내림차순 정렬 지원.
#### 검색 및 필터
| 구분 | 필드명 | 타입 | 설명 |
| :--- | :--- | :--- | :--- |
| **필터** | 파트너 이름 | 선택(Select) | 기본값: 전체 |
| **필터** | 요청 유형 | 선택(Select) | 기본값: 전체 |
| **기간** | 요청 일 시작 | DatePicker | 기본값: 오늘 - 1개월 |
| **기간** | 요청 일 종료 | DatePicker | 기본값: 오늘 |
| **필터** | 합의 유형 | 선택(Select) | **옵션**: 전체, 1단계 승인, 2단계 승인 |
| **필터** | 상태 | 선택(Select) | **옵션**: 전체, 요청, 승인, 반려 |

#### 컬럼 정의
| 헤더명 | 정렬 | 데이터 정의 및 로직 |
| :--- | :--- | :--- |
| **오더 ID** | O | |
| **차량 번호** | O | |
| **차종** | O | |
| **존 이름** | O | |
| **파트너 이름** | O | 요청을 보낸 파트너사 명칭 |
| **요청 유형** | O | 변경 내용을 명시적으로 표시. 예: `현장 변경(내부→내외부)`, `전환(현장→입고)`, `입고 변경(내외부→특수)` |
| **요청 일시** | O | `YYYY-MM-DD HH:mm` 형식 |
| **합의 유형** | O | 1단계 승인 / 2단계 승인 (섹션 4 참조) |
| **상태** | O | **[배지]**<br>- **요청**: Warn (Orange)<br>- **승인**: Ok (Green)<br>- **반려**: Danger (Red) |
| **처리 주체** | O | **[배지]** 인터널(Green) / 파트너(Gray) (미처리 시 `-`) |
| **처리 일시** | O | 승인/반려 처리 시각 `YYYY-MM-DD HH:mm` (미처리 시 `-`) |

#### 처리 주체 정책
| 처리자 유형 | 처리 주체 표기 | 판별 기준 |
| :--- | :--- | :--- |
| **내부 관리자** | 인터널 | 영문 닉네임 (예: brown, asti, iron) |
| **파트너 관리자** | 파트너 | 한글 이름 (예: 김길동, 이영희) |

> **참고**: 2단계 승인 유형에서는 내부 관리자만 처리 가능하므로, 처리 주체가 항상 "인터널"로 표시됩니다.

### 2.2 합의 요청 상세 (Drawer)
목록의 행(Row) 클릭 시 우측 드로어가 열리며, 상세 정보를 확인하고 의사결정을 수행합니다.

- **타이틀**: `합의 요청 상세 - {요청ID}` (예: A-1001)

#### A. 요청 정보 섹션
리스트 컬럼과 동일한 순서로 표시합니다.

| 필드 | 설명 |
| :--- | :--- |
| **오더 ID** | |
| **차량 번호** | |
| **차종** | |
| **존 이름** | |
| **파트너 이름** | |
| **요청 유형** | `{유형}({변경 전}→{변경 후})` 형식 |
| **요청 일시** | `YYYY-MM-DD HH:mm` 형식 |
| **합의 유형** | 배지 표시 (1단계: Green, 2단계: Orange) |
| **상태** | 배지 표시 (요청/승인/반려) |
| **처리 주체** | **1단계 승인 시**: 배지 표시 (인터널: Green, 파트너: Gray) (미처리 시 `-`) |
| **처리자** | **1단계 승인 시**: 처리한 관리자 이름 (미처리 시 `-`) |
| **1차 처리자** | **2단계 승인 시**: 파트너 담당자 이름 (예: 김00). 파트너 선승인 완료 시 표시 |
| **2차 처리자** | **2단계 승인 시**: 인터널 담당자 영어 이름 (예: brown). 승인/반려 상태에서만 값 표시 |
| **처리 일시** | 처리 시각 (미처리 시 `-`) |

---

| 필드 | 설명 |
| :--- | :--- |
| **청구 금액** | 상태='요청' 시 수정 가능, 그 외 비활성화 |
| **요청 코멘트** | 수행원이 합의 요청 시 입력한 메시지 |
| **반려 코멘트** | '반려' 상태에서만 표시 |

#### B. 현장 사진 섹션
- **이미지**: 세차 전 상태를 증빙하는 현장 사진 미리보기 영역. (현재 Placeholder 제공)

#### C. 승인 및 반려 처리 (Footer/Action)
상태가 **'요청'**일 경우에만 하단 액션 버튼이 노출됩니다. 그 외 상태에서는 '닫기' 버튼만 제공됩니다.

1.  **승인 (Approve)**
    - **트리거**: '승인' 버튼 클릭.
    - **로직**: 현재 입력된 '청구 금액'으로 비용을 확정하며, 상태를 **'승인'**으로 변경.
2.  **반려 (Reject)**
    - **트리거**: '반려' 버튼 클릭.
    - **UI 동작**: 드로어 내부 최하단에 **반려 사유 입력 영역(Card)**이 활성화됨 (별도 팝업 아님).
    - **반려 확정**: 사유 입력 후 '반려 확정' 버튼 클릭 시, 상태를 **'반려'**로 변경하고 입력된 사유를 **반려 코멘트**에 저장.
    - **취소**: 반려 입력 모드를 종료하고 상세 화면 유지.

## 3. 비즈니스 로직

### 3.1 상태 전이 및 수정 제한
- **수정 권한**: 오직 **'요청'** 상태에서만 청구 금액 수정 및 승인/반려 처리가 가능합니다.
- **종결 처리**: **'승인'** 또는 **'반려'** 상태로 변경된 건은 최종 상태로 간주하여, 더 이상 금액이나 상태를 변경할 수 없습니다.

### 3.2 금액 합의 (Negotiation)
- 운영자는 파트너사가 요청한 초기 금액을 확인 후, 합의된 금액으로 **Input 필드를 수정한 뒤 승인**할 수 있습니다. 시스템은 승인 시점의 금액을 최종 합의 금액으로 저장합니다.

---

## 4. 승인 프로세스 유형

합의 요청은 **승인 단계**에 따라 두 가지 프로세스로 구분됩니다.

| 구분 | 1단계 승인 | 2단계 승인 |
| :--- | :--- | :--- |
| **노출 방식** | 파트너 어드민 + 인터널 어드민 **동시 노출** | 파트너 어드민 **선노출** → 선승인 후 인터널 어드민 노출 |
| **승인 주체** | 파트너 매니저 또는 쏘카 운영자 (선착순 1인) | 파트너 매니저(1차) → 쏘카 운영자(최종) |
| **목적** | 현장 대기 시간 최소화 | 고비용 건에 대한 비용 남용 방지 |

### 4.1 1단계 승인

- **정의**: 요청 건이 접수되면 파트너 어드민과 인터널 어드민 양쪽에 **즉시 노출**되며, 어느 쪽에서든 승인하면 합의가 완료되는 프로세스
- **목적**: 현장 대기 시간을 최소화하여, 작업자의 번거로움으로 인한 **필수 작업 누락을 방지**

### 4.2 2단계 승인

- **정의**: 파트너사 관리자가 **선승인을 완료해야만** 인터널 어드민에 노출되며, 이후 쏘카 운영자가 최종 승인을 해야 합의가 완료되는 프로세스
- **목적**: 고비용이 발생하는 입고 건에 대해 파트너사 내부의 **1차 필터링**을 거쳐 비용 남용을 방지

#### 2단계 승인 일시 정책

인터널 어드민 관점에서의 일시 필드 정의:

| 필드 | 의미 | 설명 |
| :--- | :--- | :--- |
| **요청 일시** | 1차 처리자(파트너) 승인 시점 | 파트너 관리자가 선승인을 완료한 시각. 이 시점부터 인터널 어드민에 노출됨 |
| **처리 일시** | 2차 처리자(인터널) 승인/반려 시점 | 쏘카 운영자가 최종 승인 또는 반려한 시각. 미처리 시 `-` |

> **참고**: 1단계 승인의 경우, 요청 일시는 수행원이 합의 요청을 접수한 시점이며, 처리 일시는 파트너 또는 인터널 관리자가 처리한 시점입니다.

---

## 5. 합의 요청 발생 케이스

합의 요청은 아래 **총 8가지 케이스**에서 발생합니다.

### 5.1 전체 케이스 요약

| # | 요청 유형 | 변경 내용 | 승인 프로세스 |
| :---: | :--- | :--- | :---: |
| 1 | 현장 변경(내부→내외부) | 현장 세차 유형 상향 | 1단계 |
| 2 | 현장 변경(외부→내외부) | 현장 세차 유형 상향 | 1단계 |
| 3 | 현장 변경(라이트→내부) | 현장 세차 유형 상향 | 1단계 |
| 4 | 현장 변경(라이트→외부) | 현장 세차 유형 상향 | 1단계 |
| 5 | 현장 변경(라이트→내외부) | 현장 세차 유형 상향 | 1단계 |
| 6 | 전환(현장→입고) | 파트너 유형 전환 (현장→입고, 특수) | 1단계 |
| 7 | 입고 변경(내외부→특수) | 입고 세차 유형 상향 | 2단계 |
| 8 | 입고 변경(내외부→협의) | 입고 세차 유형 상향 | 2단계 |

---

### 5.2 현장 변경 (케이스 1~5)

**정의**: 오염도 심화 등으로 인해 현장에서 세차 유형을 상향하는 경우

| 변경 전 | 변경 후 | 요청 유형 값 |
| :---: | :---: | :--- |
| 내부 | 내외부 | `현장 변경(내부→내외부)` |
| 외부 | 내외부 | `현장 변경(외부→내외부)` |
| 라이트 | 내부 | `현장 변경(라이트→내부)` |
| 라이트 | 외부 | `현장 변경(라이트→외부)` |
| 라이트 | 내외부 | `현장 변경(라이트→내외부)` |

- **승인 프로세스**: 1단계 승인 (현장 대기 시간 최소화)

---

### 5.3 전환 (케이스 6)

**정의**: 현장 해결 불가로 입고(특수) 세차로 전환하는 경우

| 변경 전 | 변경 후 | 요청 유형 값 |
| :---: | :---: | :--- |
| [파트너: 현장] | [파트너: 입고], [세차 유형: 특수] | `전환(현장→입고)` |

- **승인 프로세스**: 1단계 승인

---

### 5.4 입고 변경 (케이스 7~8)

**정의**: 입고 후 검수 과정에서 특수 오염 처리가 필요한 경우

| 변경 전 | 변경 후 | 요청 유형 값 |
| :---: | :---: | :--- |
| 내외부 | 특수 | `입고 변경(내외부→특수)` |
| 내외부 | 협의 | `입고 변경(내외부→협의)` |

- **승인 프로세스**: 2단계 승인 (파트너 선승인 필수, 비용 남용 방지)

> **참고**: 입고 파트너는 내부/외부 단독 세차 유형이 없으므로, 내외부 → 특수/협의만 해당됩니다.