# 오더 관리

## 1. 개요
- **화면명**: 오더 관리
- **목적**: 세차 오더의 생명주기(발행~완료) 관리 및 모니터링
- **주요 기능**: 조회/필터링, 수기 발행, 상세/타임라인 확인, 상태 변경(완료/삭제)

## 2. 데이터 정책

### 2.1 데이터 모델
| 구분 | 필드 구성 | 비고 |
| :--- | :--- | :--- |
| **오더 기본** | ID, 구분(긴급/정규/변경/수시/특별), 발행유형, 세차유형, 점검유형(A/B/C/D), 상태, 취소유형, 참조 오더 ID | 점검유형은 세차유형에 종속. 취소유형은 취소 상태에서만 유효 |
| **차량 정보** | 차량 ID, 번호, 차종, 존(ID/이름), 지역(1/2) | 발행 시 실시간 조회 |
| **파트너** | 파트너 이름, 유형(현장/입고/핸들러), 수행원 | 유형 기본값: 현장 |
| **탁송 정보** | 입고/출고 예약 ID, 탁송 상태 | 입고 파트너 전용. 출고는 완료 상태에서만 표시 |
| **상세 데이터** | 메모, 사진(전/후/기타), 점검결과, 미션(스냅샷), 분실물 | - |

### 2.2 상태 전이
- **기본 흐름**: `발행` → `예약` → `수행 중` → `완료` (모든 단계에서 `취소` 가능)
- **탁송 상태** (핸들러): WAITING → ASSIGN → RUN → END/FORCE_END/CANCEL

### 2.3 취소 유형

#### 시스템
| 취소 유형 | 설명 |
| :--- | :--- |
| 시스템(변경 취소) | 오더 내용 변경 시 기존 오더 취소 후 재발행 |
| 시스템(미예약 취소) | 발행 후 24시간 내 파트너 예약 미완료 |
| 시스템(예약 불가) | 미예약 취소 조건에서, 수행원이 예약할 수 없었던 것으로 판단되는 경우 |
| 시스템(노쇼 취소) | 수행원이 예약 시간에 맞춰 시작하지 않은 경우 |
| 시스템(우천 취소) | 우천으로 세차 불가 |

> **시스템(예약 불가) 판단 조건**
> - **현장 세차**: `세차수행시간 + 4시간`이 해당 차량 예약 테이블에 예약 가능 시간으로 존재하지 않는 경우
> - **입고 세차**: `배반차 핸들시간 + 쿠션시간 + 세차수행시간 + 4시간`이 해당 차량 예약 테이블에 예약 가능 시간으로 존재하지 않는 경우
> - **예약 가능 시간**: (1) 예약이 없는 시간 구간 또는 (2) 장애블락 예약 구간 (수행원이 세차블락으로 변경 가능)

#### 수행원
| 취소 유형 | 설명 |
| :--- | :--- |
| 수행원(차량 없음) | 배정된 차량이 존에 없음 |
| 수행원(주차장 문제) | 주차장 문제로 세차 불가 |
| 수행원(기타) | 기타 사유 |
| 수행원(개인 사유) | 수행원 개인 사정 |

### 2.4 오더 참조 관계
오더는 미수행(취소) 시 동일 차량에 대해 재생성될 수 있으며, 재생성된 오더는 이전 오더를 참조합니다.

- **참조 오더 ID**: 직전에 취소된 오더의 ID (없으면 최초 발행 오더)
- **참조 오더 발행일시**: 직전에 취소된 오더의 발행 시점
- 참조 관계는 연쇄적으로 발생할 수 있음 (A → B → C → …)
- **최초 발행 오더 식별**: 참조 오더 ID가 없는 오더가 최초 발행 오더
- **리드 타임 계산**: 참조 관계로 연결된 모든 오더의 `발행~취소` 구간을 합산하여 산출

### 2.5 파트너 유형별 정책
| 파트너 유형 | 허용 세차 유형 | UI 특이사항 |
| :--- | :--- | :--- |
| **현장** | 내외부, 내부, 외부, 라이트 | 기본 흐름 |
| **입고** | 내외부, 협의, 특수 | 탁송 정보 카드 표시 (기본 정보 → 탁송 정보 → 금액/연계) |
| **핸들러** | 기계세차 | "미션 및 분실물" 탭 숨김, 수행원 `-`, 금액 카드 숨김, 미션핸들 예약 정보 카드 표시 |

### 2.6 점검 유형 매핑
세차 유형 선택 시 점검 유형이 자동 결정됩니다.
- **A유형**: 입고(특수, 협의) — 전체 점검 + 긴급조치/시트탈거
- **B유형**: 입고(내외부), 현장(긴급) — 전체 점검 (긴급조치 제외)
- **C유형**: 현장(내외부, 내부, 외부) — 해당 영역 항목만
- **D유형**: 라이트 — 라이트 전용 항목

### 2.7 미션 연동
- **발행 시**: 차량의 `대기` 미션 → 오더에 스냅샷 저장
- **수행 시**: 수행원이 선택적 처리 (강제 아님), 완료된 미션만 `완료` 상태로 변경
- **취소 시**: 오더 연결 해제, 수행 완료 미션은 `완료` 유지, 미수행 미션은 `대기` 복원

---

## 3. 화면 구성 및 기능

### 3.1 리스트

#### 액션 버튼
- **[오더 발행]**: 긴급/수기 오더 생성 (Drawer)
- **[목록 다운로드]**: 현재 필터 결과를 Excel 다운로드

#### 검색 및 필터
| 구분 | 필드 | 설명 |
| :--- | :--- | :--- |
| 검색 | 검색어 | 차량 번호(기본), 차량 ID, 오더 ID, 존 이름 선택 |
| 기간 | 발행일 시작~종료 | 기본값: 최근 1개월 |
| 필터 | 지역1 | 시/도 |
| 필터 | 지역2 | 구/군 (지역1 선택 전 비활성화. 지역1 변경 시 초기화) |
| 필터 | 오더 구분 | 긴급, 정규, 변경, 수시, 특별 |
| 필터 | 발행 유형 | 위생장애, 고객 피드백(ML)_긴급, 초장기 미세차, 주기세차 등 |
| 필터 | 세차 유형 | 내외부, 내부, 외부, 특수, 협의, 라이트, 기계세차 |
| 필터 | 파트너 이름 | 파트너사 명 |
| 필터 | 파트너 유형 | 현장, 입고, 핸들러 |
| 필터 | 진행 상태 | 발행, 예약, 수행 중, 완료, 취소 |
| 필터 | 취소 유형 | 진행 상태 '취소' 선택 전까지 비활성화 (회색 처리). 취소 선택 시 활성화 |

- 필터 칩: 적용 조건 표시 + 개별 삭제(X)
- 초기화: 모든 조건 리셋 + 기간 최근 1개월 복원

#### 컬럼 (15개)
오더 ID, 오더 구분, 발행 유형, 세차 유형, 차량 ID, 차량 번호, 차종, 지역1, 지역2, 존 이름, 파트너 이름, 파트너 유형, 진행 상태(배지), 취소 유형(취소 시만), 발행 일시

- **상태 배지**: 완료(초록), 발행/예약(주황), 수행 중(파랑), 취소(회색)
- **기본 정렬**: 오더 ID 내림차순
- **페이지네이션**: 40건

#### 대시보드 연동 (Quick Filter)
대시보드에서 `quickFilter` props로 필터값 전달 (status, orderType, cancelType, partner)

### 3.2 상세 (Drawer)

3개의 탭으로 구성됩니다. 핸들러 파트너는 "미션 및 분실물" 탭 숨김.

#### ① 상세정보 탭
- **기본 정보**: 오더 ID, 차량 ID, 차량 번호, 차종, 존, 지역, 발행/세차 유형, 파트너, 수행원, 진행 상태, 취소 유형(취소 시만, 진행 상태 우측), 발행/수행 일시, 메모
- **탁송 정보** (입고 전용): 입고/출고 예약 ID + 탁송 상태. 별도 카드.
- **미션핸들 예약 정보** (핸들러 전용): 미션핸들 예약 ID + 예약 상태. 별도 카드.
- **금액 및 연계 정보** (핸들러 제외): 최종 청구 금액, 연계 오더(입고 전용)
- **[수행 완료]**: 오더 상태 "완료" 처리
- **[오더 취소]**: 사유 입력 필수. 취소 상태에서는 버튼 숨김

#### ② 사진 및 점검 탭
- **진행 이력**: 상태 변경 타임라인
- **사진**: 세차 전/후 사진, 기타 사진 (D유형은 세차 전 사진 미노출)
  - 핸들러: 세차 전 1~5장, 세차 후 7~10장, 세차 후기 1~100자
- **점검 리스트**: 유형별(A~D) 점검 결과
  - 이상 항목: 빨간색 '이상' 배지 + 증빙 사진
  - 타이어 관련: 2×2 Grid (FL/FR/RL/RR)

#### ③ 미션 및 분실물 탭
- **미션**: 연동된 미션 목록 및 상태
- **분실물**: 분실물 ID(클릭 시 새창), 접수일시, 구분, 처리상태, 상세 정보

### 3.3 오더 수기 발행 (Drawer)
1. 차량번호 입력 → 차량정보 자동 조회 (차종, 존, 파트너 표시)
2. 오더 구분, 발행유형, 세차유형 선택
3. [발행하기] → 대기 미션 N건 자동 포함 알림
- **필수값**: 차량번호(DB 존재 확인), 오더구분, 발행유형, 세차유형
- **차량 미등록 시**: 발행 차단 + 경고 메시지

---

## 4. 운영 시나리오

**긴급 오더 발행**: [오더 발행] → 차량번호 → 차량정보 확인 → "긴급" 선택 → 유형 선택 → [발행하기]

**오더 완료 처리**: 행 클릭 → ② 사진 및 점검 탭에서 확인 → ③ 미션 확인 → [수행 완료]

**예외사항**:
- 차량 조회 실패 시 오더 발행 불가 (차량 등록 선행 필요)
- 오더 취소 시 반드시 사유 입력 (감사 로그 기록)
- 미션은 수행원이 선택적으로 처리, 수행 완료한 미션만 '완료' 상태
